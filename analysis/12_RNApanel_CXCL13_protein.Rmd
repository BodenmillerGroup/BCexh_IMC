---
title: "12_RNApanel_CXCL13_protein"
author: "SandraTietscher"
date: "2020-11-11"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
```

# Preparations

# Load packages, helper functions and data

```{r message=FALSE, warning=FALSE}
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(igraph)
library(reshape2)
library(cowplot)
library(ggridges)
library(tidyverse)
library(viridis)
library(dplyr)
library(sp)
library(sf)
library(RANN)
library(concaveman)
library(ggpubr)
library(data.table)

sce = readRDS(file = "output/RNApanel/sce_RNApanel_cytokines_communities.rds")

# Read object relationship file (output from Cellprofiler)
dat_relation <- fread("data/cpout/Object_relationships_RNApanel.csv")
dat_relation$cellA <- paste0(dat_relation$`First Image Number`, "_", dat_relation$`First Object Number`)
dat_relation$cellB <- paste0(dat_relation$`Second Image Number`, "_", dat_relation$`Second Object Number`)
```

# Calculate distance to the next CXCL13_mRNA expressing cell (for each cell)

For images in which there is no CXCL13_mRNA positive cell --> set distance parameter to NA and exclude for further analysis.
Only search in a radius of 200 (otherwise give back maximu)

```{r calculate-distance}
cur_sce <- data.frame(colData(sce))
cellIDs_cxcl13 <- cur_sce[cur_sce[,"CXCL13_mRNA_expression"] == 1,]
new_sce <- data.frame(matrix(ncol=length(colnames(cur_sce))+1, nrow = 0))

# For each image separately: nearest neighbour search

for (j in unique(cur_sce$ImageNumber)) {
  cur_sce_j <- filter(cur_sce, ImageNumber == j)
  cxcl13_j <- filter(cellIDs_cxcl13, ImageNumber == j)[,c("Center_X", "Center_Y")]
  if (nrow(cxcl13_j) == 0) {
    cur_sce_j$cxcl13_distance <- NA
  } else {
    j_coord <- cur_sce_j[,c("Center_X", "Center_Y")]
    nn <- RANN::nn2(cxcl13_j, j_coord)
    cur_sce_j$cxcl13_distance <- nn$nn.dists[,1]
  }
  new_sce <- rbind(cur_sce_j, new_sce)
}
```

# Plot distance in correlation with CXCL13_protein expression

```{r distance-cxcl13-expression}
new_sce$CXCL13_protein <- assay(sce, "counts")["CXCL13_protein",]
new_sce_sub <- new_sce[!is.na(new_sce$cxcl13_distance),]

# Remove outlier cells (mean counts > 30)
new_sce_sub <- new_sce_sub[new_sce_sub$CXCL13_protein <= 30,]

# Bin the distances
breaks <- seq(from = 0, to = 1000, by = 5)
new_sce_sub$distance_tag <- cut(new_sce_sub$cxcl13_distance, breaks = breaks, include.lowest = TRUE, right = TRUE)

ggplot(new_sce_sub, aes(cxcl13_distance, CXCL13_protein)) +
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  stat_cor(method="spearman")+
  theme(axis.line.x = element_line(colour = "black", size = 0.25),
        axis.line.y = element_line(colour = "black", size = 0.25),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.background = element_blank())

```

# Identify direct neighbours of CXCL13_RNA positive cells

```{r neighbour-cxcl13-expression, fig.width=5,fig.height=4}
cxcl13_shortID <- paste0(cellIDs_cxcl13$ImageNumber, "_", cellIDs_cxcl13$CellNumber)

# Subset neighbourhood list
dat_relation_sub <- dat_relation %>% filter(cellA %in% cxcl13_shortID | cellB %in% cxcl13_shortID)
neighbours <- unique(c(dat_relation_sub$cellA, dat_relation_sub$cellB))
neighbours <- setdiff(neighbours, cxcl13_shortID)

# Add information to colData
cur_sce$shortID <- paste0(cur_sce$ImageNumber, "_", cur_sce$CellNumber)
cur_sce$cxcl13_status <- ifelse(cur_sce$shortID %in% cxcl13_shortID, "mRNA_expressing", ifelse(cur_sce$shortID %in% neighbours, "neighbour", "none"))
cur_sce$cxcl13_counts <- assay(sce, "counts")["CXCL13_protein",]

# Plot
ggplot(cur_sce, aes(cxcl13_status, cxcl13_counts))+
         geom_boxplot(outlier.shape = NA)+
    coord_cartesian(ylim=c(0, 8))+
    theme(axis.line.x = element_line(colour = "black", size = 0.25),
        axis.line.y = element_line(colour = "black", size = 0.25),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.background = element_blank())

```

