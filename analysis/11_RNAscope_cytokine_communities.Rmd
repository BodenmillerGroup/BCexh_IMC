---
title: "11_RNAscope_cytokine_communities"
author: "SandraTietscher"
date: "2020-11-03"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

This script uses Tobi's functions to detect interaction networks of a given celltype (here: cytokine producing cells) and defines these networks as clusters. Once a cluster is defined, an algorithm screens the neighbourhood of those clusters to identify cells within/surrounding a cluster. These cells are defined as the community of a cluster. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
```

# Preparations

# Load packages, helper functions and data

```{r message=FALSE, warning=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(igraph)
library(reshape2)
library(cowplot)
library(ggridges)
library(tidyverse)
library(viridis)
library(dplyr)
library(sp)
library(sf)
library(RANN)
library(concaveman)
library(ggpubr)

sce = readRDS(file = "output/RNApanel/sce_RNApanel_cytokines_subtypes.rds")
```

# Clusters/Communities - General

## Find clusters of cytokine-producing cells and define communities

A cluster of cytokine-producing cells consists of cells (min. 10) that have a max distance of 20µm to the next cytokine producing cells. 
A community is defined by cells which surround (max 25µm) the border of a cluster (definded by the convex hull of the cluster).  

```{r Cluster and Community Detection cytokines general}
# average cell diameter
sqrt(mean(sce$Area)/pi)
sqrt(median(sce$Area)/pi)
quantile(sqrt(sce$Area/pi))

# find cytokine clusters
sce <- findClusters(sce, sce[,colData(sce)$cytokine == TRUE]$cellID , 
                    'cellID', 
                    'Center_X', 'Center_Y', 
                    'ImageNumber', 
                    distance = 20, 
                    min_clust_size = 10,
                    output_colname = "cytokine_cluster")

# number of cytokine clusters
length(unique(sce$cytokine_cluster))

# define cells within/surrounding a cluster of cytokine producing cells
sce <- findCommunity(sce, 
                     'cellID', 
                     'Center_X', 'Center_Y', 
                     'ImageNumber', 
                     'cytokine_cluster', 
                     distance = 25,
                     output_colname = "cytokine_community")

# number of cytokine communities
length(unique(sce$cytokine_community))
```

# Detect Clusters and Commmunities for Single cytokines

```{r cluster-detection-single}
start = Sys.time()
cytokine_channels = c("CCL4", "CCL18", "CSF1", "CXCL10", "CXCL13_mRNA", "CCL2", "CCL22", "CXCL9", "CCL17", "CCL5")
cur_sce <- data.frame(colData(sce))

# loop through all cytokines
for(i in cytokine_channels) {

  # find clusters
  sce <- findClusters(input_sce = sce, 
                    IDs_of_interest = cur_sce[cur_sce[,names(cur_sce) == paste0(i, "_expression")] == 1,]$cellID, 
                    'cellID', 
                    'Center_X', 'Center_Y', 
                    'ImageNumber', 
                    distance = 25, 
                    min_clust_size = 3,
                    output_colname = paste(tolower(i), "only_clust", sep = ""))

  
  # define cells within/surrounding a cluster of cytokine producing cells
  sce <- findCommunity(sce, 
                     'cellID', 
                     'Center_X', 
                     'Center_Y', 
                     'ImageNumber', 
                     paste(tolower(i), "only_clust", sep = ""), 
                     distance = 30,
                     output_colname = paste(tolower(i), "only_comm", sep = ""))
} 
end = Sys.time()
print(end-start)
```

# Save SCE object

```{r save-sce}
saveRDS(sce, file = "output/RNApanel/sce_RNApanel_cytokines_communities.rds")
```

# Cluster size distribution

```{r cluster-sizes}
#For general cytokine-expressing cluster
cytokine_cluster <- as.data.frame(table(sce$cytokine_cluster)[-1])
ggplot(cytokine_cluster, aes(x=Freq))+
  geom_histogram(binwidth = 10)

#For individual single-cytokine clusters
cur_sce <- data.frame(colData(sce))
clust_colnames <- colnames(cur_sce)[grep("only_clust", colnames(cur_sce))]

p.list <- list()
for (i in clust_colnames) {
  cluster <- as.data.frame(table(cur_sce[,i])[-1])
  p.list[[i]] <- ggplot(cluster, aes(x=Freq))+ geom_histogram(binwidth = 1) + ggtitle(i) + ylab("Cluster size")
  
}
plot_grid(plotlist = p.list, ncol = 4)
```

# Community size distribution

```{r comminity-sizes}
#For general cytokine-expressing cluster
cytokine_community <- as.data.frame(table(sce$cytokine_community)[-1])
ggplot(cytokine_community, aes(x=Freq))+
  geom_histogram(binwidth = 10)

#For individual single-cytokine clusters
comm_colnames <- colnames(cur_sce)[grep("only_comm", colnames(cur_sce))]

p.list <- list()
for (i in comm_colnames) {
  comm <- as.data.frame(table(cur_sce[,i])[-1])
  p.list[[i]] <- ggplot(comm, aes(x=Freq))+ geom_histogram(binwidth = 1) + ggtitle(i) + ylab("Community size")
  
}
plot_grid(plotlist = p.list, ncol = 4)
```

# Cytomapper: cytokine cluster plots

```{r cytomapper-cluster, message = FALSE}
library(cytomapper)

# Load mask files
path.to.images <- "data/masks/RNApanel_masks"
all_masks <- loadImages(path.to.images, pattern = "_mask.tiff")

# Add image number
mcols(all_masks)$ImageNumber <- c(1:77)

# Scale images
all_masks <- scaleImages(all_masks, 2^16-1)
head(unique(as.numeric(all_masks[[1]])))

cur_img <- getImages(all_masks, "20200817_ST_BCexh_R_TBB165_s0_p3_r1_a1_ac_ilastik_s2_Probabilities_mask")

# Plot cells
plotCells(cur_img, object = sce,
            img_id = "ImageNumber", cell_id = "CellNumber",
            colour_by = "ccl22only_clust")

plotCells(cur_img, object = sce,
            img_id = "ImageNumber", cell_id = "CellNumber",
            colour_by = c("CCL22"), exprs_values = "exprs")

```

# Cell type proportions

## Cell type proportions in clusters

```{r cytokine-cluster-celltypes}
# For individual single-cytokine clusters

celltype_prop <- data.frame(celltype = names(prop.table(table(cur_sce[,"celltype"]))))
celltype_prop[,"all"] <- as.numeric(prop.table(table(cur_sce[,"celltype"])))

for (i in clust_colnames) {
  cur_sce_i <- cur_sce[which(cur_sce[,i] != 0),]
  prop_i <- as.data.frame(prop.table(table(cur_sce_i[,"celltype"])))
  colnames(prop_i) <- c("celltype", i)
  celltype_prop <- merge(celltype_prop, prop_i, by="celltype", all.x = TRUE)
}

celltype_prop[is.na(celltype_prop)] = 0
celltype_prop <- pivot_longer(celltype_prop, 2:12, names_to = "cluster", values_to = "celltype_proportion")

# Plot
ggplot(celltype_prop, aes(cluster, celltype_proportion, fill = celltype))+
  geom_bar(stat = "identity")+
    theme(axis.title.x=element_blank(),panel.background = element_blank(), axis.text.x = element_text(angle = 60, hjust = 1))+
  ggtitle("Cell type proportions per cytokine cluster")
```

## Cell type proportions in communities

```{r cytokine-community-celltypes}
# For individual single-cytokine communities: ALL CELLS IN THE COMMUNITY

celltype_comm <- data.frame(celltype = names(prop.table(table(cur_sce[,"celltype"]))))
celltype_comm[,"all"] <- as.numeric(prop.table(table(cur_sce[,"celltype"])))

for (i in comm_colnames) {
  cur_sce_i <- cur_sce[which(cur_sce[,i] != 0),]
  prop_i <- as.data.frame(prop.table(table(cur_sce_i[,"celltype"])))
  colnames(prop_i) <- c("celltype", i)
  celltype_comm <- merge(celltype_comm, prop_i, by="celltype", all.x = TRUE)
}

celltype_comm[is.na(celltype_comm)] = 0
celltype_comm <- pivot_longer(celltype_comm, 2:12, names_to = "cluster", values_to = "celltype_proportion")

# Plot
ggplot(celltype_comm, aes(cluster, celltype_proportion, fill = celltype))+
  geom_bar(stat = "identity")+
    theme(axis.title.x=element_blank(),panel.background = element_blank(), axis.text.x = element_text(angle = 60, hjust = 1))+
  ggtitle("Cell type proportions per cytokine community")


# For individual single-cytokine communities: ONLY CELLS IN THE COMMUNITY THAT ARE NOT ALSO IN THE CLUSTER

celltype_commonly <- data.frame(celltype = names(prop.table(table(cur_sce[,"celltype"]))))
celltype_commonly[,"all"] <- as.numeric(prop.table(table(cur_sce[,"celltype"])))

for (i in cytokine_channels) {
  cur_sce_i <- cur_sce[which(cur_sce[,str_detect(colnames(cur_sce), regex(paste0(i,"only_clust"), ignore_case = TRUE))] == 0 & cur_sce[,str_detect(colnames(cur_sce), regex(paste0(i,"only_comm"), ignore_case = TRUE))] != 0),]
  prop_i <- as.data.frame(prop.table(table(cur_sce_i[,"celltype"])))
  colnames(prop_i) <- c("celltype", i)
  celltype_commonly <- merge(celltype_commonly, prop_i, by="celltype", all.x = TRUE)
}

celltype_commonly[is.na(celltype_commonly)] = 0
celltype_commonly <- pivot_longer(celltype_commonly, 2:12, names_to = "cluster", values_to = "celltype_proportion")

# Plot
ggplot(celltype_commonly, aes(cluster, celltype_proportion, fill = celltype))+
  geom_bar(stat = "identity")+
    theme(axis.title.x=element_blank(),panel.background = element_blank(), axis.text.x = element_text(angle = 60, hjust = 1))+
  ggtitle("Cells that are ONLY part of the respective cytokine community (not the cluster)")
```

## Compare cell type proportions in clusters and communities

```{r cluster-community-celltype-comparison}
# Compare
celltype_prop$cluster <- celltype_commonly$cluster
celltype_prop$type <- "cluster"
celltype_commonly$type <- "community"
celltype_comb <- rbind(celltype_prop, celltype_commonly)

ggplot(celltype_comb, aes(type, celltype_proportion, fill = celltype))+
  geom_bar(stat = "identity")+
  facet_wrap(~cluster, ncol = 6)+
    theme(axis.title.x=element_blank(),panel.background = element_blank(), axis.text.x = element_text(angle = 60, hjust = 1))+
  ggtitle("Celltype proportions in cytokine clusters vs communities")
```

# CCL18 - Treg association

```{r CCL18-Treg-correlation}
# Simple frequencies
sce_protein <- readRDS("output/ProteinPanel/sce_ProteinPanel_subtypes_all.rds")
sce_stromal <- sce_protein[, which(sce_protein$cell_class == "stroma")]
prop_Treg <- prop.table(table(sce_stromal$ImageNumber, sce_stromal$subtype), margin = 1)[,"Treg"]
CCL18_clust_cellnr <- rowSums(table(sce$ImageNumber, sce$ccl18only_clust)[, -1])

Treg_CCL18 <- as.data.frame(cbind(prop_Treg, CCL18_clust_cellnr))

ggplot(Treg_CCL18, aes(prop_Treg, CCL18_clust_cellnr)) +
  geom_point()+
  geom_smooth(method = lm, color = "black", se=FALSE)+
  stat_cor(method="spearman")+
  theme(axis.line.x = element_line(colour = "black", size = 0.25),
        axis.line.y = element_line(colour = "black", size = 0.25),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.background = element_blank())

# See if the same holds true for general cytokine expression
cytokine_cellnr <- table(sce$ImageNumber, sce$cytokine)[,2]
cytokine_clust_cellnr <- rowSums(table(sce$ImageNumber, sce$cytokine_cluster)[, -1])
Treg_cytokine <- as.data.frame(cbind(prop_Treg, cytokine_clust_cellnr))

ggplot(Treg_cytokine, aes(prop_Treg, cytokine_clust_cellnr)) +
  geom_point()+
  geom_smooth(method = lm, color = "black", se=FALSE)+
  stat_cor(method="spearman")+
  theme(axis.line.x = element_line(colour = "black", size = 0.25),
        axis.line.y = element_line(colour = "black", size = 0.25),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.background = element_blank())
```

# Cytokine environments -> apply to matched ROIs

Define "cytokine environments" by extending the respective cytokine communities by 10um (concave hull), thus allowing for slight mismatches between the different ROIs.   
Extract coordinates for these environments and lay them over the matched ROIs from the protein panel.   
Check enrichment of celltypes and subtypes in the overlaid environments for different cytokines.

The goal is to investigate association of cytokine expression with celltypes that can only be defined in the Protein Panel (e.g. regulatory T cells).
  
```{r cytokine-environment-proteinpanel}
# read in SCE from protein panel
sce_protein <- readRDS("output/ProteinPanel/sce_ProteinPanel_subtypes_all.rds")
sce_TNK <- sce_protein[,which(sce_protein$celltype == "T_NK")]

# ColData column names for cytokine communities
comm_colnames <- c(colnames(colData(sce))[grep("only_comm", colnames(colData(sce)))],"cytokine_community")

# Create empty cell type enrichment tables
enrichment <- data.frame(matrix(ncol=length(levels(as.factor(sce_protein$subtype))), nrow = 0))
colnames(enrichment) = levels(as.factor(sce_protein$subtype))

enrichment_TNK <- data.frame(matrix(ncol=length(levels(as.factor(sce_TNK$subtype))), nrow = 0))
colnames(enrichment_TNK) = levels(as.factor(sce_TNK$subtype))

# Set distance parameter
distance = 10

for (k in comm_colnames) {
  
input_df_RNA <- data.frame(cellID = sce$cellID,
                       X = sce$Center_X,
                       Y = sce$Center_Y,
                       ImageNumber = sce$ImageNumber,
                       cluster = colData(sce)[,k])

input_df_protein <- data.frame(cellID = sce_protein$cellID,
                       X = sce_protein$Center_X,
                       Y = sce_protein$Center_Y,
                       ImageNumber = sce_protein$ImageNumber)

# Create empty dataframe to collect all cells in the respective cytokine environment
k_env_cells <- data.frame(matrix(ncol=ncol(input_df_protein), nrow = 0))
colnames(k_env_cells) = colnames(input_df_protein)

for (j in unique(input_df_RNA$ImageNumber)) {
  
  # create multipoint object with all cells from one image (for RNA panel)
    cell_coord = as.matrix(input_df_RNA[input_df_RNA$ImageNumber == j,2:3])
    rownames(cell_coord) = input_df_RNA[input_df_RNA$ImageNumber == j,1]
    cells = sf::st_multipoint(cell_coord)
    cells_sfc = sf::st_cast(sf::st_sfc(cells), "POINT")
    
  # create multipoint object with all cells from one image (for Protein panel)
    cell_coord_protein = as.matrix(input_df_protein[input_df_protein$ImageNumber == j,2:3])
    rownames(cell_coord_protein) = input_df_protein[input_df_protein$ImageNumber == j,1]
    cells_protein = sf::st_multipoint(cell_coord_protein)
    cells_sfc_protein = sf::st_cast(sf::st_sfc(cells_protein), "POINT")
    
  # create data.frame for all environment cells for the respective image
    environment_cells = data.frame(matrix(ncol=ncol(input_df_protein), nrow = 0))
    colnames(environment_cells) = colnames(input_df_protein)

  # create list for plots/polygon objects
    polygon_plots = ggplot()
    
  # loop through all clusters of k in image j and extract coordinates of enlarged polygon
    for(i in unique(input_df_RNA[input_df_RNA$ImageNumber == j & input_df_RNA$cluster != 0,]$cluster)){
      
      cur_df <- input_df_RNA[input_df_RNA$cluster == i & input_df_RNA$cluster != 0,]

      ## Compute concave hull for each cluster
      if (nrow(cur_df) > 2){
          coords <- as.matrix(cbind(cur_df$X, cur_df$Y))
          hull = data.table::as.data.table(concaveman::concaveman(coords, concavity = 1))
          colnames(hull) <- c("X", "Y")

          # return common rows between input and the hull
          # first, we need to round the digits of cur_df since concaveman does not return full-length coordinates
          # (see github issue https://github.com/joelgombin/concaveman/issues/13)
          # is obsolete once the bug is fixed
          cur_df_2 <- data.table::copy(cur_df)
          cur_df_2$X <- round(cur_df_2$X, digits = 4)
          cur_df_2$Y <- round(cur_df_2$Y, digits = 4)

          # create polygon object
          polygon = sf::st_polygon(list(as.matrix(hull)))
        }

      # buffer/enlarge polygon by "distance" pixels
      polygon_buff = sf::st_buffer(polygon, distance)
      polygon_buff_sfc = sf::st_sfc(polygon_buff)

      polygon_plots <- polygon_plots +
        geom_sf(data = polygon, fill = NA, size = 4, col = "deepskyblue2") +
        geom_sf(data = polygon_buff_sfc, fill = NA, size=4, col = "blue")

      # return coordinates of the enlarged polygon
      enlarged_coordinates = as.data.frame(polygon_buff[1])
      
      # define cells within this enlarged polygon in the matched ROI from the protein panel
      intersect = sf::st_intersects(polygon_buff_sfc, cells_sfc_protein)
      intersect = rownames(as.data.frame(cells_protein[intersect[[1]],]))
      environment_cells = rbind(environment_cells, input_df_protein[input_df_protein$cellID %in% intersect,])
    }
  
  # Add cells to the data frame for k
  k_env_cells = rbind(k_env_cells, environment_cells)
}

#Calculate enrichment of celltypes in environment k
sce_k_env <- sce_protein[,unique(k_env_cells$cellID)]
enrichment[k,] <- prop.table(table(sce_k_env$subtype)) / prop.table(table(sce_protein$subtype))

sce_k_env_TNK <- sce_k_env[,which(sce_k_env$celltype == "T_NK")]
enrichment_TNK[k,] <- prop.table(table(sce_k_env_TNK$subtype)) / prop.table(table(sce_TNK$subtype))
}
```

### Plot celltype enrichments in cytokine environments

```{r cytokine-environment-enrichment}
# Plot general enrichment of cell subtypes
enrichment$cluster <- rownames(enrichment)
enrichment_long <- pivot_longer(enrichment, 1:20, names_to = "celltype", values_to = "enrichment")

ggplot(enrichment_long, aes(celltype, enrichment, fill = celltype))+
  geom_bar(stat="identity")+
  facet_wrap(~cluster, scales = "free")+
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1),
        strip.background = element_blank(),
        legend.background = element_blank())


# Plot enrichment of Tregs in CCL18 communities vs general cytokine communities
enrichment_sub <- enrichment_long %>% filter(cluster %in% c("ccl18only_comm", "cytokine_community"))
ggplot(enrichment_sub, aes(cluster, enrichment, fill = cluster))+
  geom_bar(stat="identity")+
  facet_wrap(~celltype, scales = "free")+
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1),
        strip.background = element_blank(),
        legend.background = element_blank())
```

```{r cytokine-environment-enrichment_TNK, fig.width=8.5, fig.height=6}
# Plot enrichment of T cell subtypes OUT OF ALL TNK CELLS in all cytokine communities
enrichment_TNK$cluster <- rownames(enrichment_TNK)
enrichment_long_TNK <- pivot_longer(enrichment_TNK, 1:7, names_to = "subtype", values_to = "enrichment")

ggplot(enrichment_long_TNK, aes(cluster, enrichment, fill = cluster))+
  geom_bar(stat="identity")+
  facet_wrap(~subtype, scales = "free", ncol = 4)+
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1),
        strip.background = element_blank(),
        legend.background = element_blank())+
  geom_hline(yintercept = 1, linetype = "dashed")

```




